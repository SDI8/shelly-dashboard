services:
  mqtt:
    image: emqx/nanomq:0.24.6
    container_name: nanomq
    ports:
      - "1883:1883" # MQTT
      - "8083:8083" # MQTT over WebSocket
    volumes:
      - ./nanomq/nanomq.conf:/etc/nanomq.conf:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.2"

  questdb:
    image: questdb/questdb:9.2.2
    container_name: questdb
    ports:
      - "9000:9000" # Web Console
      - "9009:9009" # InfluxDB line protocol (for telegraf)
      - "8812:8812" # PostgreSQL wire protocol (for grafana)
    volumes:
      - questdb_data:/var/lib/questdb
    environment:
      - QDB_TELEMETRY_ENABLED=false
      - QDB_PG_ENABLED=true
      - QDB_HTTP_ENABLED=true
      - QDB_INFLUXDB_ENABLED=true
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: "1.0"
    healthcheck:
      test:
        ["CMD-SHELL", "timeout 10 bash -c '</dev/tcp/localhost/9000' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 30s

  telegraf:
    image: telegraf:1.28-alpine
    container_name: telegraf
    volumes:
      - ./telegraf/:/etc/telegraf/telegraf.d/:ro
    depends_on:
      mqtt:
        condition: service_started
      questdb:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.2"

  grafana:
    image: grafana/grafana:12.1
    container_name: grafana
    ports:
      - "3000:3000" # Grafana Web UI
    volumes:
      - grafana_data:/var/lib/grafana/
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=questdb-questdb-datasource
      - GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS=questdb-questdb-datasource
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
    depends_on:
      questdb:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

networks:
  default:
    driver: bridge

volumes:
  questdb_data:
    driver: local
  grafana_data:
    driver: local
