# Telegraf Configuration for Shelly Devices

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = true

# QuestDB Output via Socket Writer (TCP line protocol)
[[outputs.socket_writer]]
  address = "tcp://questdb:9009"
  data_format = "influx"
  tagexclude = ["device_full", "topic", "component_id"]

# MQTT Consumer for Switch Status
[[inputs.mqtt_consumer]]
  name_override = "shelly_switch"
  servers = ["tcp://mqtt:1883"]
  topics = ["+/status/switch:0", "+/status/switch:1"]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-shelly-switch"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/status/+"
    tags = "device_full/_/component_id"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shelly_switch"
    timestamp_path = ""
    timestamp_format = ""
    
    # Flatten all JSON fields
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "id"
      type = "int"
    
    # [[inputs.mqtt_consumer.json_v2.field]]
    #   path = "source"
    #   type = "string"
     
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "output"
      type = "bool"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "apower"
      rename = "active_power"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "voltage"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "current"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "aenergy.total"
      rename = "energy_total"
      type = "float"
      optional = true
    
    # [[inputs.mqtt_consumer.json_v2.field]]
    #   path = "aenergy.by_minute.0"
    #   rename = "aenergy_by_minute_0"
    #   type = "float"
    # 
    # [[inputs.mqtt_consumer.json_v2.field]]
    #   path = "aenergy.by_minute.1"
    #   rename = "aenergy_by_minute_1"
    #   type = "float"
    # 
    # [[inputs.mqtt_consumer.json_v2.field]]
    #   path = "aenergy.by_minute.2"
    #   rename = "aenergy_by_minute_2"
    #   type = "float"
    # 
    # [[inputs.mqtt_consumer.json_v2.field]]
    #   path = "aenergy.minute_ts"
    #   rename = "aenergy_minute_ts"
    #   type = "int"
    
    # Flatten temperature object
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temperature.tC"
      rename = "celsius"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "temperature.tF"
      rename = "fahrenheit"
      type = "float"

# MQTT Consumer for Shelly 3EM Energy Meter Status
[[inputs.mqtt_consumer]]
  name_override = "shelly_em"
  servers = ["tcp://mqtt:1883"]
  topics = ["+/status/em:0"]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-shelly-em"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/status/+"
    tags = "device_full/_/component_id"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shelly_em"
    timestamp_path = ""
    timestamp_format = ""
    
    # Basic fields
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "id"
      type = "int"
    
    # Phase A measurements
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_voltage"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_act_power"
      rename = "a_active_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_aprt_power"
      rename = "a_apparent_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_pf"
      rename = "a_power_factor"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_freq"
      rename = "a_frequency"
      type = "int"
    
    # Phase B measurements
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_voltage"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_act_power"
      rename = "b_active_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_aprt_power"
      rename = "b_apparent_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_pf"
      rename = "b_power_factor"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_freq"
      rename = "b_frequency"
      type = "int"
    
    # Phase C measurements
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_voltage"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_act_power"
      rename = "c_active_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_aprt_power"
      rename = "c_apparent_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_pf"
      rename = "c_power_factor"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_freq"
      rename = "c_frequency"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "n_current"
      rename = "neutral_current"
      type = "float"
      optional = true
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "total_current"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "total_act_power"
      rename = "total_active_power"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "total_aprt_power"
      rename = "total_apparent_power"
      type = "float"

# MQTT Consumer for Shelly Temperature Status
[[inputs.mqtt_consumer]]
  name_override = "shelly_temperature"
  servers = ["tcp://mqtt:1883"]
  topics = ["+/status/temperature:100", "+/status/temperature:101", "+/status/temperature:102"]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-shelly-temperature"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/status/+"
    tags = "device_full/_/component_id"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shelly_temperature"
    timestamp_path = ""
    timestamp_format = ""
    
    # Temperature sensor fields
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "id"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tC"
      rename = "celsius"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "tF"
      rename = "fahrenheit"
      type = "float"

# MQTT Consumer for accumulative Shelly 3EM Energy Data
[[inputs.mqtt_consumer]]
  name_override = "shelly_emdata"
  servers = ["tcp://mqtt:1883"]
  topics = ["+/status/emdata:0"]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-shelly-emdata"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/status/+"
    tags = "device_full/_/component_id"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shelly_emdata"
    timestamp_path = ""
    timestamp_format = ""
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "id"
      type = "int"
    
    # Phase A energy totals
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_total_act_energy"
      rename = "a_total_active_energy"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "a_total_act_ret_energy"
      rename = "a_total_active_returned_energy"
      type = "float"
    
    # Phase B energy totals
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_total_act_energy"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "b_total_act_ret_energy"
      rename = "b_total_active_returned_energy"
      type = "float"
    
    # Phase C energy totals
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_total_act_energy"
      rename = "c_total_active_energy"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "c_total_act_ret_energy"
      rename = "c_total_active_returned_energy"
      type = "float"
    
    # Total energy values
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "total_act"
      rename = "total_active_energy"
      type = "float"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "total_act_ret"
      rename = "total_active_returned_energy"
      type = "float"

# MQTT Consumer for Shelly System Status
[[inputs.mqtt_consumer]]
  name_override = "shelly_system"
  servers = ["tcp://mqtt:1883"]
  topics = ["+/status/sys"]
  qos = 0
  connection_timeout = "30s"
  client_id = "telegraf-shelly-system"
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/status/+"
    tags = "device_full/_/_"
  
  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shelly_system"
    timestamp_path = ""
    timestamp_format = ""
    
    # System identification
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "mac"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "restart_required"
      type = "bool"
    
    # Time information
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "time"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "unixtime"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "last_sync_ts"
      rename = "last_sync_timestamp"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "uptime"
      type = "int"
    
    # Memory metrics
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "ram_size"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "ram_free"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "ram_min_free"
      rename = "ram_minimum_free"
      type = "int"
    
    # Filesystem metrics
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "fs_size"
      rename = "filesystem_size"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "fs_free"
      rename = "filesystem_free"
      type = "int"
    
    # Configuration revisions
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "cfg_rev"
      rename = "config_revision"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "kvs_rev"
      rename = "kvs_revision"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "schedule_rev"
      rename = "schedule_revision"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "webhook_rev"
      rename = "webhook_revision"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "btrelay_rev"
      rename = "btrelay_revision"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "reset_reason"
      type = "int"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "utc_offset"
      type = "int"

# Processor to extract device type and ID from device_full tag
[[processors.regex]]

  [[processors.regex.tags]]
    key = "device_full"
    pattern = "^([a-zA-Z0-9]+)-([a-zA-Z0-9]+)$"
    replacement = "${1}"
    result_key = "device_type"
  
  [[processors.regex.tags]]
    key = "device_full"
    pattern = "^([a-zA-Z0-9]+)-([a-zA-Z0-9]+)$"
    replacement = "${2}"
    result_key = "device_id"


# System metrics for monitoring
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

[[inputs.mem]]

[[inputs.system]]